# Mesh Gradient Color Management

This document provides a comprehensive overview of how cell colors are defined, updated, and processed throughout the Mesh Gradient render pipeline.

## 1. Color Definition Overview

### 1.1 Primary Color Sources

- **Base Color**: Set via `setBaseColor(hexColor)` - provides a foundation for color generation
- **Color Harmony**: Set via `setColorHarmony(harmonyType)` - defines relationships between colors (complementary, analogous, etc.)
- **Color Theme**: Set via `setColorTheme(theme)` - applies predefined color palettes to the mesh
- **Direct Cell Colors**: Set via `setCellColor(cellIndex, hexColor)` - explicitly defines individual cell colors
- **Random Generation**: Default fallback when no specific colors are provided
- **Hue Animation**: Dynamic colors generated by rotating hue values over time
- **Gradient Stops**: Set via `setGradientStops(stops)` - defines color transition points

### 1.2 Color Properties

Colors in the system are represented as objects with multiple formats:
```javascript
{
  hex: "#ff5500",    // Hexadecimal representation
  h: 20,             // Hue (0-360)
  s: 100,            // Saturation (0-100)
  l: 50,             // Lightness (0-100)
  cellIndex: 2,      // Optional reference to cell position
  locked: false      // Whether the color is locked from changes
}
```

### 1.3 Color Storage Locations

- **data.currentColors**: Primary array of current rendered colors
- **data.cellColors**: Map of explicitly set colors by cell index
- **data.lockedColors**: Set of indices for cells with locked colors
- **data.colorPalette.lastGeneratedColors**: Latest palette generated by the system
- **hueAnimator.baseColors**: Original colors captured at hue animation start
- **animation.originalColors**: Original colors captured at cell animation start
- **data.gradientStops**: Array of color stops for gradient-based generation

## 2. Color Generation Flow

### 2.1 Initial Color Generation

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Generate New   │     │   Cell Count    │     │  Color Harmony/ │
│    Gradient     │     │     Change      │     │  Theme Changes  │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                      data.setupGeneration()                      │
└──────────────────────────────────────┬───────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                       data.processColors()                       │
│                                                                  │
│  1. Apply base color                                             │
│  2. Apply color harmony rules                                    │
│  3. Apply theme palette                                          │
│  4. Use gradient stops if defined                                │
│  5. Apply locked colors                                          │
│  6. Generate random colors if needed                             │
└──────────────────────────────────────┬───────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                  Store in data.currentColors                     │
└──────────────────────────────────────────────────────────────────┘
```

### 2.2 Color Access Priority

When retrieving colors, the system uses the following priority order:

1. **Locked cell colors**: Colors explicitly locked via `lockCellColor(cellIndex)`
2. **Cell-specific colors**: Colors set via `setCellColor(cellIndex, hexColor)`
3. **Current colors**: From `data.currentColors` array
4. **Last generated palette**: From `data.colorPalette.lastGeneratedColors`
5. **Default color**: Fallback if all else fails

## 3. Color Update Mechanisms

### 3.1 Color Regeneration Scenarios

When `render(colors, preserveColors=false)` is called with `preserveColors=false`:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Change Cell   │     │ Color Harmony/  │     │ Gradient Stops  │
│     Count       │     │  Theme Changes  │     │    Changed      │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌──────────────────────────────────────────────────────────────────┐
│     render(colors, preserveColors=false)                         │
└────────────────────┬─────────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│       data.processColors() - generates or processes colors       │
└────────────────────┬─────────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│  Dispatch "meshColorsChanged" event with new color array         │
└────────────────────┬─────────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────────┐
│      Draw cells with new colors and update visualization         │
└──────────────────────────────────────────────────────────────────┘
```

### 3.2 Color Preservation Scenarios

When `render(colors, preserveColors=true)` is called with `preserveColors=true`:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Cell Dragging  │     │   Cell Hover    │     │   Animation     │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌──────────────────────────────────────────────────────────────────┐
│              render(colors, preserveColors=true)                 │
└──────────────────────────────────────┬───────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────┐
│        Skip color processing, preserve existing colors           │
└──────────────────────────────────────┬───────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                  Draw cells with current colors                  │
└──────────────────────────────────────────────────────────────────┘
```

### 3.3 Direct Color Modifications

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  setCellColor   │     │  lockCellColor  │     │ unlockCellColor │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌──────────────────────────────────────────────────────────────────┐
│           Direct update to data.cellColors collection            │
│           Update data.lockedColors set as needed                 │
└──────────────────────────────────────┬───────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────┐
│              render(null, preserveColors=true)                   │
└──────────────────────────────────────────────────────────────────┘
```

### 3.4 Color Adjustment Operations

```
┌─────────────────────────────────────────────────────────────────┐
│              adjustColors({hue, saturation, lightness})         │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│              data.adjustColors(options) → modified colors       │
│                                                                 │
│  - Applies HSL adjustments to all colors                        │
│  - Respects locked colors                                       │
│  - Updates cell-specific colors                                 │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│             render(modifiedColors) - with new colors            │
└─────────────────────────────────────────────────────────────────┘
```

## 4. Animation-specific Color Handling

During cell animation, colors are carefully preserved to maintain visual consistency while positions change:

```
┌──────────────────────────┐
│    startCellAnimation    │
└───────────┬──────────────┘
            │
            ▼
┌──────────────────────────┐
│  Store originalColors =  │
│     getAllColors()       │
└───────────┬──────────────┘
            │
            ▼
┌──────────────────────────┐
│  Animation frame updates │
│ cell positions regularly │
└───────────┬──────────────┘
            │
            ▼
┌──────────────────────────┐
│ render(originalColors,   │
│   preserveColors=true)   │
└──────────────────────────┘
```

### 4.1 Hue Animation Flow

```
┌───────────────────────┐
│  startHueAnimation()  │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│  Capture baseColors   │
│  from current state   │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│  Animation loop:      │
│  - Calculate hue shift│
│  - Apply to baseColors│
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ render(shiftedColors, │
│  preserveColors=true) │
└───────────────────────┘
```

## 5. Color Rendering Pipeline

```
┌──────────────────┐
│  render() call   │
└────────┬─────────┘
         │
         ▼
┌───────────────────────────────┐     ┌──────────────────────┐
│ If !preserveColors:           │     │ If preserveColors:   │
│ - Get new colors via          │     │ - Keep existing      │
│   data.processColors()        │     │   colors             │
│ - Or use provided colors      │     └──────────┬───────────┘
│ - Dispatch meshColorsChanged  │                │
└─────────────┬─────────────────┘                │
              │                                  │
              ▼                                  ▼
┌───────────────────────────────────────────────────────────┐
│             drawCellsToCanvas with colors                 │
└─────────────────────────┬─────────────────────────────────┘
                          │
                          ▼
┌───────────────────────────────────────────────────────────┐
│             Apply blur if blurAmount > 0                  │
└─────────────────────────┬─────────────────────────────────┘
                          │
                          ▼
┌───────────────────────────────────────────────────────────┐
│                Apply distortion effects                   │
└─────────────────────────┬─────────────────────────────────┘
                          │
                          ▼
┌───────────────────────────────────────────────────────────┐
│              drawUI based on interaction                  │
└─────────────────────────┬─────────────────────────────────┘
                          │
                          ▼
┌───────────────────────────────────────────────────────────┐
│   Dispatch meshColorsAvailable (via color tracking)       │
└───────────────────────────────────────────────────────────┘
```

## 6. Color Events

The system emits several color-related events:

1. **meshColorsChanged**: Triggered when colors are regenerated (not during preserved color operations)
   - Includes complete array of new colors
   - Used by external systems to react to color changes

2. **meshColorsAvailable**: Triggered after every render operation through color tracking system
   - Includes current visible colors
   - Used for extracting current state regardless of render mode

3. **cellColorLocked**: Triggered when a cell color is locked
   - Includes cell index and color information
   - Allows UI to update accordingly

4. **cellColorUnlocked**: Triggered when a cell color is unlocked
   - Includes cell index
   - Allows UI to update accordingly

## 7. API Reference

### 7.1 Color Retrieval Methods

- **getCellColor(cellIndex)**: Get color for a specific cell
- **getAllColors()**: Get all colors currently used in the gradient
- **getBaseColor()**: Get the base color used for generation
- **getColorHarmony()**: Get current color harmony setting
- **getColorTheme()**: Get current color theme setting
- **getGradientStops()**: Get current gradient stops

### 7.2 Color Setting Methods

- **setCellColor(cellIndex, hexColor, lock=false)**: Set color for a specific cell
- **setBaseColor(hexColor)**: Set the base color for gradient generation
- **setColorHarmony(harmonyType)**: Set the color harmony relationship
- **setColorTheme(theme)**: Apply a predefined color theme
- **setGradientStops(stops)**: Set gradient stops for color generation
- **setRandomColors(enable=true)**: Enable or disable random color generation

### 7.3 Color Modification Methods

- **adjustColors({ hue, saturation, lightness })**: Adjust all colors by HSL properties
- **lockCellColor(cellIndex)**: Lock a cell's color to prevent changes
- **unlockCellColor(cellIndex)**: Unlock a previously locked cell color
- **invertColors()**: Invert all colors in the gradient
- **randomizeColors(options)**: Generate new random colors with options

### 7.4 Color Animation Methods

- **startHueAnimation(options)**: Begin animating hue values over time
- **stopHueAnimation()**: Stop ongoing hue animation
- **pulseColors(intensity, duration)**: Create a pulsing effect with colors

## 8. Technical Notes

### 8.1 Color Preservation Strategy

The system carefully distinguishes between operations that should regenerate colors (`preserveColors=false`) and those that should maintain existing colors (`preserveColors=true`). This strategy ensures UI operations like dragging cells or hovering don't cause unwanted color changes.

### 8.2 UI Color Adaptation

The system calculates the luminance of cell colors to ensure UI elements (like control pills) have appropriate contrast against their backgrounds. This adaptive approach allows UI elements to remain visible regardless of the underlying gradient colors.

```javascript
// Example of luminance calculation for UI adaptation
const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
const textColor = luminance > 128 ? '#000000' : '#FFFFFF';
```

### 8.3 Animation Color Handling

During animation, the system captures original colors at the start and consistently uses these throughout the animation to prevent color flashing or changes. This provides a smooth visual experience as cells move.

### 8.4 Color Interpolation

For smooth transitions between colors, the system uses HSL interpolation rather than RGB, which produces more visually pleasing results, especially when transitioning between different hues.

### 8.5 Performance Considerations

- Color objects are cached where possible to reduce object creation
- HSL-to-RGB conversions are optimized to minimize calculations
- Batch color operations are used when processing multiple cells